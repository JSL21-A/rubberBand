<!DOCTYPE html>
<html lang="ja"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/layout}">

<head>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link th:href="@{/css/account.css}" rel="stylesheet">


<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />


</head>
<body>
<div layout:fragment="content">

	<div class="container">
		<h1>設定</h1>

		<!-- 프로필 -->
		<!-- 프로필 -->
		<!-- 프로필 -->
		<div class="section">
			<div class="info-block">
				<div class="section-title">プロフィール</div>
				<div class="nickname" th:text="${userProfile.nickname}"></div>
				<div class="sub-text" th:text="'@' + ${currentUser.username}"></div>
			</div>

			<img
				th:src="@{${userProfile.userImg != null ? userProfile.userImg : '/images/tttpanda.png'}}"
				alt="プロフィール" class="profile-photo" /> <a href="/mypage/profileEdit"
				class="btn-outline" role="button">プロフィール編集</a>
		</div>



		<div class="section">
			<div class="info-block">
				<div class="section-title">レジュメ管理</div>
				<div class="email">
					<!-- 이메일 관련 정보가 있다면 여기에 추가 -->
				</div>
			</div>
			<div class="button-column">
				<a class="btn-outline"
					th:href="${hasResume} ? '/mypage/resumeView' : '/mypage/resumeInsert'"
					th:text="${hasResume} ? 'レジュメを見る' : 'レジュメ作成'"></a>
			</div>

		</div>


		<!-- 밴드 -->
		<div class="section">
			<div class="info-block">
				<div class="section-title">マイバンド</div>
				<span th:if="${myBand != null}" th:text="${myBand.band_name}">バンド名</span>
				<span th:if="${myBand == null}">未所属</span>

				<div class="email">
					<!-- 이메일 관련 정보가 있다면 여기에 추가 -->
				</div>
			</div>
			<div class="button-column">
				<button type="button" id="bandPageBtn" class="btn-outline" th:if="${myBand != null}" th:onclick="|window.location.href='@{/bandinsertselect/modify(band_id=${myBand.band_id})}'|">バンドページ</button>
				<button type="button" th:if="${myBand != null}" id="leaveBandBtn" class="btn-outline" th:attr="data-band-id=${myBand.band_id}">退会する</button>
			</div>
		</div>

		<!-- 이메일 변경 -->
		<div class="section">
			<div class="info-block">
				<div class="section-title">メールアドレスの変更</div>
				<div class="section-desc">パスワード認証後にメールアドレスを変更できます。</div>
			</div>
			<button class="btn-outline">変更</button>
		</div>

		<!-- 비밀번호 변경 -->
		<div class="section">
			<div class="info-block">
				<div class="section-title">パスワードの変更</div>
				<div class="section-desc">パスワードを確認し、新しいパスワードを設定してください。</div>
			</div>
			<button onclick="openPasswordModal()" class="btn btn-outline">変更</button>
		</div>

		<!-- 통합 모달 : 비밀번호 인증 + 변경을 한 번에 입력 -->
		<div id="passwordModal" class="modal">
			<div class="modal-content">
				<button class="close" onclick="closePasswordModal()">&times;</button>

				<h2 class="modal-title">パスワードの変更</h2>
				<p class="modal-desc">現在のパスワードと新しいパスワードを入力してください。</p>

				<div class="input-group">
					<label for="currentPassword">現在のパスワード</label> <input
						type="password" id="currentPassword" placeholder="現在のパスワード">
				</div>

				<div class="input-group">
					<label for="newPassword">新しいパスワード</label> <input type="password"
						id="newPassword" placeholder="英数字・記号 10～16文字">
				</div>

				<div class="input-group">
					<label for="confirmPassword">新しいパスワード（確認）</label> <input
						type="password" id="confirmPassword" placeholder="もう一度入力">
				</div>

				<p id="changeError" class="error-text"></p>

				<div class="button-row">
					<button onclick="updatePassword()">変更する</button>
				</div>
			</div>
		</div>

		<!-- 회원탈퇴 -->
		<div class="section">
			<div class="info-block">
				<div class="section-title">アカウント削除</div>
			</div>
			<span class="btn-text-link" onclick="confirmWithdraw()">アカウントを退会する</span>
		</div>
	</div>

	<script>
		function confirmWithdraw() {
			if (confirm("本当に退会しますか？")) {
				alert("退会処理が完了しました。");
			}
		}
	</script>

	<script>

	$(function(){

	  $(document).on('click', '#leaveBandBtn', function(e){
	    e.preventDefault();

	    const bandId = $(this).data('band-id');
	    if (!bandId) {
	      alert('バンドIDが取得できませんでした。');
	      return;
	    }

	    const userId = window.currentUser;
	    if (!userId || userId === 'anonymous') {
	      alert('ユーザー情報がありません。もう一度ログインしてください。');
	      return;
	    }

	    if (!confirm('本当にこのバンドを退会しますか？')) {
	      return;
	    }

	    $.ajax({
	      url: '/mypage/leaveBand',
	      method: 'POST',
	      data: {
	        user_id: userId,
	        band_id: bandId
	      },
	      success: function(){
	        alert('バンドの退会が完了しました。');
	        location.reload();
	      },
	      error: function(xhr, status, error){
	        console.error('退会失敗:', status, error);
	        alert('退会に失敗しました。もう一度お試しください。');
	      }
	    });

	  });

	});
	
	</script>

	<!-- 비밀번호 변경 -->
	<script>
  document.addEventListener('DOMContentLoaded', function () {
    // 모달 열기
    window.openPasswordModal = function () {
      document.getElementById("passwordModal").style.display = "flex";
    };

    // 모달 닫기
    window.closePasswordModal = function () {
      document.getElementById("passwordModal").style.display = "none";
      document.getElementById("changeError").textContent = "";
      document.getElementById("currentPassword").value = "";
      document.getElementById("newPassword").value = "";
      document.getElementById("confirmPassword").value = "";
    };

    // 비밀번호 변경 처리 (영문+숫자 or 숫자+기호를 포함한 10~16자)
    window.updatePassword = function () {
      const currentPw = document.getElementById("currentPassword").value.trim();
      const newPw = document.getElementById("newPassword").value.trim();
      const confirmPw = document.getElementById("confirmPassword").value.trim();
      const errorMsg = document.getElementById("changeError");

      errorMsg.textContent = "";

      if (!currentPw || !newPw || !confirmPw) {
        errorMsg.textContent = "すべての項目を入力してください。";
        return;
      }

      if (currentPw === newPw) {
        errorMsg.textContent = "現在のパスワードと異なるパスワードを入力してください。";
        return;
      }

      const pwRegex = /^(?=.*[A-Za-z0-9])[A-Za-z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]{10,16}$/;
      if (!pwRegex.test(newPw)) {
        errorMsg.textContent = "10〜16文字、英数字または記号を含めてください。";
        return;
      }

      if (newPw !== confirmPw) {
        errorMsg.textContent = "パスワードが一致しません。";
        return;
      }

      const token = document.querySelector('meta[name="_csrf"]').getAttribute("content");
      const headerName = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

      fetch("/mypage/update-password", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          [headerName]: token
        },
        body: JSON.stringify({
          currentPassword: currentPw,
          newPassword: newPw
        })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert("パスワードが変更されました。");
            window.location.href = "/mypage/account";
          } else {
            errorMsg.textContent = data.message || "変更に失敗しました。";
          }
        })
        .catch(error => {
          console.error("エラー:", error);
          errorMsg.textContent = "サーバーエラーが発生しました。";
        });
    };
  });
</script>
	
</div>




</body>
</html>